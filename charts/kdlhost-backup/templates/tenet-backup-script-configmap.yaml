apiVersion: v1
kind: ConfigMap
metadata:
  name: tenet-backup-script
  namespace: {{ .Release.Namespace }}
data:
  tenet-backup.sh: |
    #!/bin/sh
    set -euo pipefail

    LOGFILE=/backup-logs/tenet-backup.log
    mkdir -p /backup-logs
    echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') üîÑ Tenet backup started" >> "$LOGFILE"

    DISCORD_WEBHOOK=$(cat /etc/discord/{{ .Values.discord.secretKey }} 2>/dev/null || true)
    notify() { [ -n "$DISCORD_WEBHOOK" ] && curl -s -H "Content-Type: application/json" -d "{\"content\":\"$1\"}" "$DISCORD_WEBHOOK" >/dev/null 2>&1; }

    TIMESTAMP=$(date +"%Y%m%d%H%M")

    # Get namespaces with label backup=tenet
    NAMESPACES=$(kubectl get ns -l backup=tenet -o jsonpath='{.items[*].metadata.name}')

    for NS in $NAMESPACES; do
      BACKUP_NAME="tenet-${NS}-${TIMESTAMP}"
      echo "$(date -u) Creating backup ${BACKUP_NAME}" >> "$LOGFILE"
      velero backup create "$BACKUP_NAME" \
        --include-namespaces "$NS" \
        --storage-location "{{ .Values.tenet.storageLocation }}" \
        --ttl "{{ .Values.tenet.ttl }}" \
        --snapshot-volumes={{ .Values.tenet.snapshotVolumes }} >> "$LOGFILE" 2>&1 \
        || notify "‚ùå Tenet backup ${BACKUP_NAME} FAILED"

      echo "$(date -u) Backup ${BACKUP_NAME} completed" >> "$LOGFILE"
    done

    notify "‚úÖ Tenet backups completed"

    # Cleanup old tenet-* backups
    velero backup get -o json \
      | jq -r ".[] | select(.metadata.name|startswith(\"tenet-\")) | select(.status.startTimestamp != null and (.status.startTimestamp | fromdateiso8601) < (now - {{ .Values.tenet.retentionDays }}*86400)) | .metadata.name" \
      | xargs -r -n1 velero backup delete --confirm >> "$LOGFILE" 2>&1

    # Optionally push log to S3
    {{- if .Values.logToS3 }}
    aws --endpoint-url=$(velero get config storage-location get "{{ .Values.tenet.storageLocation }}" | jq -r '.s3Url') \
      s3 cp "$LOGFILE" "s3://{{ .Values.logS3BucketPrefix }}/tenet-backup-${TIMESTAMP}.log" || echo "‚ö†Ô∏è Failed to upload log"
    {{- end }}

    # Optionally update ConfigMap
    {{- if .Values.logToConfigMap }}
    kubectl create configmap tenet-backup-log \
      --from-file=tenet-backup.log="$LOGFILE" \
      --namespace {{ .Release.Namespace }} \
      -o yaml --dry-run=client | kubectl apply -f - || true
    {{- end }}
