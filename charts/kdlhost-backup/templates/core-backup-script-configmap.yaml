apiVersion: v1
kind: ConfigMap
metadata:
  name: core-backup-script
  namespace: {{ .Release.Namespace }}
data:
  core-backup.sh: |-
    #!/bin/sh
    set -euo pipefail

    LOGFILE=/backup-logs/core-backup.log
    mkdir -p /backup-logs
    echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') üîÑ Core backup started" >> "$LOGFILE"

    DISCORD_WEBHOOK=$(cat /etc/discord/{{ .Values.discord.secretKey }} 2>/dev/null || true)
    notify() { [ -n "$DISCORD_WEBHOOK" ] && curl -s -H "Content-Type: application/json" -d "{\"content\":\"$1\"}" "$DISCORD_WEBHOOK" >/dev/null 2>&1; }

    TIMESTAMP=$(date +"%Y%m%d%H%M")
    for NS in {{ .Values.core.namespaceWhitelist }}; do
      BACKUP_NAME="core-${NS}-${TIMESTAMP}"
      echo "$(date -u) Creating backup ${BACKUP_NAME}" >> "$LOGFILE"
      velero backup create "$BACKUP_NAME" \
        --include-namespaces "$NS" \
        --storage-location "{{ .Values.core.storageLocation }}" \
        --ttl "{{ .Values.core.ttl }}" \
        --snapshot-volumes={{ .Values.core.snapshotVolumes }} >> "$LOGFILE" 2>&1 \
        || notify "‚ùå Core backup ${BACKUP_NAME} FAILED"
      echo "$(date -u) Backup ${BACKUP_NAME} completed" >> "$LOGFILE"
    done

    notify "‚úÖ Core backups completed"

    # Cleanup old backups
    velero backup get -o json \
      | jq -r ".[] | select(.metadata.name|startswith(\"core-\")) | select(.status.startTimestamp != null and (.status.startTimestamp | fromdateiso8601) < (now - {{ .Values.core.retentionDays }}*86400)) | .metadata.name" \
      | xargs -r -n1 velero backup delete --confirm >> "$LOGFILE" 2>&1

{{- if .Values.logToS3 }}
    # Optionally push log to S3
    aws --endpoint-url=$(velero get config storage-location get "{{ .Values.core.storageLocation }}" | jq -r '.s3Url') \
      s3 cp "$LOGFILE" "s3://{{ .Values.logS3BucketPrefix }}/core-backup-${TIMESTAMP}.log" || echo "‚ö†Ô∏è Failed to upload log"
{{- end }}

{{- if .Values.logToConfigMap }}
    # Optionally update ConfigMap
    kubectl create configmap core-backup-log \
      --from-file=core-backup.log="$LOGFILE" \
      --namespace {{ .Release.Namespace }} \
      -o yaml --dry-run=client | kubectl apply -f - || true
{{- end }}
