apiVersion: v1
kind: ConfigMap
metadata:
  name: core-backup-script
  namespace: {{ .Release.Namespace }}
data:
  core-backup.sh: |
    #!/bin/sh
    set -euo pipefail
    log() { echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') $*"; }

    STORAGE="{{ .Values.core.storageLocation }}"
    TTL="{{ .Values.core.ttl }}"
    RETENTION={{ .Values.core.retentionDays }}
    DISALLOWED_SCS="{{- range $i, $sc := .Values.core.disallowedStorageClasses }}{{$sc}}{{if ne (add $i 1) (len $.Values.core.disallowedStorageClasses)}} {{end}}{{- end}}"
    TIMESTAMP=$(date +"%Y%m%d%H%M")

    ALERT_ENABLED="{{ .Values.enableAlerts }}"
    ALERT_TYPE="{{ .Values.alertWebhookType }}"
    ALERT_WEBHOOK=$(cat /etc/alerts/{{ .Values.core.alertSecretKey }} 2>/dev/null || echo "")

    notify() {
      [ "$ALERT_ENABLED" != "true" ] && return
      [ -z "$ALERT_TYPE" ] || [ -z "$ALERT_WEBHOOK" ] && return
      case "$ALERT_TYPE" in
        discord)
          curl -s -H "Content-Type: application/json" -d "{\"content\":\"$1\"}" "$ALERT_WEBHOOK" >/dev/null 2>&1 ;;
      esac
    }

    notify "ðŸ”„ Core backup started"

    RESULTS="Core backup summary:\n"

    NS_LIST=$(kubectl get ns -o json | jq -r '.items[] | select(.metadata.labels.backup != "tenet") | .metadata.name')

    for NS in $NS_LIST; do
      bad_sc_found=0
      PVC_SC_LIST=$(kubectl -n "$NS" get pvc -o jsonpath='{range .items[*]}{.metadata.name}::${.spec.storageClassName}{"\n"}{end}' 2>/dev/null || true)
      if [ -n "$PVC_SC_LIST" ]; then
        echo "$PVC_SC_LIST" | while IFS= read -r line; do
          sc=$(printf '%s' "$line" | awk -F"::" '{print $2}')
          [ -z "$sc" ] && sc="<none>"
          for D in $DISALLOWED_SCS; do
            [ "$sc" = "$D" ] && bad_sc_found=1 && break
          done
          [ $bad_sc_found -eq 1 ] && break
        done
      fi

      BACKUP_NAME="core-${NS}-${TIMESTAMP}"

      if [ $bad_sc_found -eq 1 ]; then
        if velero backup create "$BACKUP_NAME" --include-namespaces "$NS" --storage-location "$STORAGE" --ttl "$TTL" --snapshot-volumes=false; then
          RESULTS="${RESULTS}- ${BACKUP_NAME}: completed (snapshots disabled)\n"
        else
          RESULTS="${RESULTS}- ${BACKUP_NAME}: FAILED\n"
        fi
      else
        if velero backup create "$BACKUP_NAME" --include-namespaces "$NS" --storage-location "$STORAGE" --ttl "$TTL" --snapshot-volumes=true; then
          RESULTS="${RESULTS}- ${BACKUP_NAME}: completed\n"
        else
          RESULTS="${RESULTS}- ${BACKUP_NAME}: FAILED\n"
        fi
      fi
    done

    OLD_BACKUPS=$(velero backup get -o json \
      | jq -r ".[] | select(.metadata.name|startswith(\"core-\")) | select(.status.startTimestamp != null and (.status.startTimestamp | fromdateiso8601) < (now - ${RETENTION}*86400)) | .metadata.name")

    for OLD in $OLD_BACKUPS; do
      velero backup delete "$OLD" --confirm
      RESULTS="${RESULTS}- Deleted old backup: ${OLD}\n"
    done

    notify "âœ… Core backups completed\n$RESULTS"
