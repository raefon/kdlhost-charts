apiVersion: v1
kind: ConfigMap
metadata:
  name: tenet-backup-script
  namespace: {{ .Release.Namespace }}
data:
  tenet-backup.sh: |
    #!/bin/sh
    set -euo pipefail

    LOGFILE=/backup-logs/tenet-backup.log
    mkdir -p /backup-logs
    echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') ðŸ”„ Tenet backup started" >> "$LOGFILE"

    DISCORD_WEBHOOK=$(cat /etc/discord/{{ .Values.discord.secretKey }} 2>/dev/null || true)
    notify() { [ -n "$DISCORD_WEBHOOK" ] && curl -s -H "Content-Type: application/json" -d "{\"content\":\"$1\"}" "$DISCORD_WEBHOOK" >/dev/null 2>&1; }

    TIMESTAMP=$(date +"%Y%m%d%H%M")
    
    # Get namespaces with label backup=tenet
    NAMESPACES=$(kubectl get ns -l backup=tenet -o jsonpath='{.items[*].metadata.name}')

    for NS in $NAMESPACES; do
      BACKUP_NAME="tenet-${NS}-${TIMESTAMP}"
      echo "$(date -u) Backing up namespace ${NS}" >> "$LOGFILE"

      # K8s resources
      kubectl get all,configmaps,secrets,roles,rolebindings -n $NS -o yaml > /backup-logs/${BACKUP_NAME}.yaml

      # Optional PV backup using Restic
      if {{ .Values.tenet.snapshotVolumes }}; then
        PODS=$(kubectl get pods -n $NS -o jsonpath='{.items[*].metadata.name}')
        for POD in $PODS; do
          VOLUMES=$(kubectl get pod $POD -n $NS -o jsonpath='{.spec.volumes[*].name}')
          for VOL in $VOLUMES; do
            MOUNT_PATH=$(kubectl get pod $POD -n $NS -o jsonpath="{.spec.containers[0].volumeMounts[?(@.name=='$VOL')].mountPath}" || true)
            if [ -n "$MOUNT_PATH" ]; then
              restic -r /backup-logs/restic-repo/$NS/$VOL backup $MOUNT_PATH >> "$LOGFILE" 2>&1 || echo "âš ï¸ Failed to backup $POD/$VOL"
            fi
          done
        done
      fi

      echo "$(date -u) Backup ${BACKUP_NAME} completed" >> "$LOGFILE"
    done

    notify "âœ… Tenet backups completed"
